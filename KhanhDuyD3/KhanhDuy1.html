<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khánh Duy 1</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        #chart {
            margin: auto;
            /* Center the chart */
            text-align: center;
            /* Center the content within the div */
        }

        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #aaa;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div style="margin-left: 50px;">
        <h3">Câu hỏi 3: </h3>
            <div style="margin-left: 30px;">
                <h3><b>Yêu cầu:</b> Báo cáo số lượng chấn thương trong các loại điều kiện ánh
                    sáng
                </h3>
                <h3>Thiết kế biểu đồ:</h3>
            </div>
            <div style="margin-left: 50px;">
                <p">Ở trong yêu cầu này, ta sẽ sử dụng 2 thuộc tính là "Number of Injuries"
                    và
                    "Illumination Description"
                    để đếm số lượng chấn thương trong các loại điều kiện ánh sáng
                    </p>
                    <p">Ta sẽ sử dụng các kênh sau</p>
                        <p">- Vị trí theo chiều dọc: Thuộc tính số lượng chấn thương</p>
                            <p">- Vị trí theo chiều ngang: Thuộc tính điều kiện ánh sáng</p>
                                <p">- Màu sắc để tăng hiệu quả biểu đạt</p>
                                    <p">Để thể hiện sự chênh lệch giữa các điều kiện ánh sáng, ta sử dụng biểu đồ
                                        cột
                                        </p>
            </div>
    </div>
    <h1 style="text-align: center;">Biểu đồ số lượng chấn thương theo điều kiện ánh sáng</h1>
    <div id="chart"></div>
    <div style="margin-left: 80px;">
        <h3>Đánh giá biểu đồ:</h3>
        <div style="margin-left: 20px;">
            <p>Ảnh hưởng của Ánh Sáng: Số liệu cho thấy mối liên hệ rõ ràng giữa điều kiện ánh sáng và số lượng chấn
                thương.
            </p>
            <p>Tăng cường An Toàn Giao Thông: Cần có biện pháp cải thiện ánh sáng và nhận thức để giảm thiểu rủi ro tai
                nạn
                giao
                thông, đặc biệt là vào các điều kiện ánh sáng thấp.</p>
            <p>Điểm Mù và Nguy Hiểm: Cần chú ý đặc biệt đến các điểm mù và nguy hiểm trong điều kiện tối không có ánh
                sáng,
                nơi
                mà rủi ro tai nạn có thể tăng cao.</p>
            <p>Nhận Thức và Hành Vi Lái Xe: Việc nắm bắt và hiểu rõ hơn về tác động của điều kiện ánh sáng có thể cải
                thiện
                hành
                vi lái xe và giúp tăng cường an toàn giao thông.</p>
        </div>
    </div>
    <script>
        d3.csv("Traffic_Accidents.csv").then(function (data) {
            var countData = countInjuriesByIllumination(data);
            // Sort countData in descending order
            countData.sort(function (a, b) {
                return b.count - a.count;
            });

            // Set the dimensions of the chart
            var width = 700;
            var height = 400;
            var margin = { top: 20, right: 20, bottom: 90, left: 70 };

            // Create an SVG element and set the dimensions
            var svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Set up scales for the x and y axes
            var x = d3.scaleBand()
                .domain(countData.map(function (d) { return d.illumination; }))
                .range([0, width])
                .padding(0.1);

            var y = d3.scaleLinear()
                .domain([0, d3.max(countData, function (d) { return d.count; })])
                .nice()
                .range([height, 0]);

            // Create x and y axes
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", "-.55em")
                .attr("transform", "rotate(-90)");

            svg.append("g")
                .call(d3.axisLeft(y));

            // Draw bars
            svg.selectAll(".bar")
                .data(countData)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", function (d) { return x(d.illumination); })
                .attr("y", function (d) { return y(d.count); })
                .attr("width", x.bandwidth())
                .attr("height", function (d) { return height - y(d.count); })
                .attr("fill", "#69b3a2")
                .on("mouseover", function (event, d) {
                    d3.select(this).attr("fill", "#ff7f0e");
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html("<strong>Loại chiếu sáng:</strong> " + d.illumination + "<br><strong>Số lượng chấn thương:</strong> " + d.count)
                        .style("left", (event.pageX) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mousemove", function (event) {
                    var mouseCoords = d3.pointer(event);
                    tooltip.style("left", (mouseCoords[0] + 180) + "px")
                        .style("top", (mouseCoords[1] + 350) + "px");
                })
                .on("mouseout", function (d) {
                    d3.select(this).attr("fill", "#69b3a2");
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add labels on top of each bar
            svg.selectAll(".text")
                .data(countData)
                .enter().append("text")
                .attr("class", "label")
                .attr("x", function (d) { return x(d.illumination) + x.bandwidth() / 2; })
                .attr("y", function (d) { return y(d.count) - 5; }) // Shift up a bit to avoid overlap
                .text(function (d) { return d.count; })
                .attr("text-anchor", "middle")
                .attr("font-size", "12px")
                .attr("fill", "black");

            // Add label for x-axis
            svg.append("text")
                .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.top + 40) + ")")
                .style("text-anchor", "middle")
                .style("color", "red")
                .style("font-weight", "bold")
                .text("Loại chiếu sáng");

            // Add label for y-axis
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .style("font-weight", "bold")
                .text("Số lượng chấn thương khi xảy ra va chạm");

            // Thêm biến global cho tooltip
            var tooltip = d3.select("#chart")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

        }).catch(function (error) {
            console.error("Error loading the data: " + error);
        });

        function countInjuriesByIllumination(data) {
            var injuriesCounts = {};

            // Loop through the data array and count injuries for each Illumination Description
            data.forEach(function (d) {
                var illumination = d["Illumination Description"];
                var numberInjuries = d["Number of Injuries"]; // Adjust the data field name
                // Merge null, others, and unknown into a single category "Others"
                if (illumination === "" || illumination === "OTHER" || illumination === "UNKNOWN") {
                    illumination = "OTHER";
                }
                if (numberInjuries > 0) {
                    if (!injuriesCounts[illumination]) {
                        injuriesCounts[illumination] = 0;
                    }
                    injuriesCounts[illumination] += parseInt(numberInjuries);
                }
            });

            // Convert the object to an array of objects
            var countData = Object.keys(injuriesCounts).map(function (key) {
                return { illumination: key, count: injuriesCounts[key] };
            });

            return countData;
        }
    </script>
</body>

</html>