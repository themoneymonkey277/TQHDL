<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biểu đồ biến động số lượng vụ tai nạn theo từng tháng của mỗi năm</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Thêm các style cho biểu đồ */
        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 2px;
        }

        .axis text {
            font: 10px sans-serif;
        }

        .comment-container {
            margin-top: 10px;
            margin-bottom: 10px; /* Thêm margin-bottom để tạo khoảng cách với biểu đồ */
            text-align: left;
        }

        .comment-text {
            font-size: 20px;
            color: black;
            margin: 0;
            margin-left: 150px;
        }

        .bold-text {
            font-weight: bold;
        }

        .dot {
            fill: steelblue; /* Màu của chấm tròn */
        }

        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            pointer-events: none;
            opacity: 0;
        }

        .dot-label {
            font-size: 12px;
            fill: black;
            text-anchor: middle;
        }
    </style>
</head>

<body>
    <div style="margin-left: 50px;">
        <h3">Câu hỏi 8: </h3>
            <div style="margin-left: 30px;">
                <h3><b>Yêu cầu:</b> Báo cáo số lượng vụ tai nạn theo từng tháng của năm
                </h3>
                <h3>Thiết kế biểu đồ:</h3>
            </div>
            <div style="margin-left: 50px;">
                <p">Ở trong yêu cầu này, sử dụng thuộc tính Date and Time để tính số lượng vụ tai nạn xảy ra theo tháng và năm
                    </p>
                    <p">Ta sẽ sử dụng các kênh sau</p>
                        <p">- Vị trí theo chiều dọc: Thuộc tính số lượng các vụ tai nạn</p>
                            <p">- Vị trí theo chiều ngang: Thuộc tính tháng</p>
                                <p">- Sử dụng filter lọc theo năm để xem của từng năm</p>
            </div>
    </div>
    <h1 style="text-align: center;">Biểu đồ biến động số lượng vụ tai nạn theo từng tháng của mỗi năm</h1>
    <div id="chart-container">
        <label for="yearDropdown">Chọn năm:</label>
        <select id="yearDropdown"></select>
    </div>
    <div style="margin-left: 80px;">
        <h3>Đánh giá biểu đồ:</h3>
        <div style="margin-left: 20px;">
            <p>Biểu đồ giúp phân tích xu hướng biến động của số lượng vụ tai nạn qua các tháng và năm.
            </p>
            <p>Bằng cách phân tích biểu đồ, có thể nhận ra các mô hình hoặc xu hướng tăng giảm đột ngột trong số lượng vụ tai nạn trong các tháng cụ thể hoặc qua các năm.</p>
        </div>
    </div>

    <script>
        d3.csv("Traffic_Accidents.csv").then(function(data) {
            console.log(data);
            // Tiền xử lý dữ liệu: Trích xuất thông tin về tháng và năm từ cột "Date and Time"
            data.forEach(function(d) {
                var dateTime = new Date(d["Date and Time"]);
                d.month = dateTime.getMonth() + 1; // Lấy tháng (từ 1 đến 12)
                d.year = dateTime.getFullYear(); // Lấy năm
            });

            // Filter và tính tổng số vụ tai nạn cho mỗi tháng của mỗi năm            
            var accidentsByMonthAndYear = {};

            data.forEach(function(d) {
                var year = d.year;
                var month = d.month;
                if (!accidentsByMonthAndYear[year]) {
                    accidentsByMonthAndYear[year] = {};
                }
                if (!accidentsByMonthAndYear[year][month]) {
                    accidentsByMonthAndYear[year][month] = 0;
                }
                accidentsByMonthAndYear[year][month]++;
            });

            // Tạo danh sách các năm cho dropdown
            var years = Object.keys(accidentsByMonthAndYear);
            console.log(years);
            var yearDropdown = d3.select("#yearDropdown");
            yearDropdown.selectAll("option")
                .data(years)
                .enter().append("option")
                .attr("value", function(d) { return d; })
                .text(function(d) { return d; });

            // Hàm để tính trung bình số vụ tai nạn cho từng tháng của mỗi năm
            function calculateAverageAccidentsByMonth(year) {
                var accidentsByMonth = accidentsByMonthAndYear[year];
                var averageData = [];
                for (var month = 1; month <= 12; month++) {
                    var totalAccidents = accidentsByMonth[month] || 0;
                    averageData.push({ month: month, accidents: totalAccidents });
                }
                return averageData;
            }

            // Hàm để vẽ đường biểu đồ cho dữ liệu trung bình số vụ tai nạn của mỗi năm
            function drawAverageLine(year) {
                var averageData = calculateAverageAccidentsByMonth(year);
                var line = d3.line()
                    .x(function(d) { return x(d.month); })
                    .y(function(d) { return y(d.accidents); });

                // Vẽ đường trung bình
                svg.append("path")
                    .datum(averageData)
                    .attr("class", "average-line")
                    .attr("d", line);
            }

            // Hàm để cập nhật biểu đồ khi chọn năm
            function updateChart(year) {
                var yearData = accidentsByMonthAndYear[year];
                drawLineChart(yearData);
                drawAverageLine(year);
            }

            // Thêm sự kiện lắng nghe khi chọn năm từ dropdown
            yearDropdown.on("change", function() {
                var selectedYear = this.value;
                updateChart(selectedYear);
            });

            // Hàm để vẽ biểu đồ line chart
            function drawLineChart(yearData) {
                // Xóa biểu đồ cũ (nếu có)
                d3.select("#line-chart").remove();

                // Tạo biểu đồ mới
                var svgWidth = 900;
                var svgHeight = 500;
                var margin = { top: 50, right: 50, bottom: 50, left: 50 };
                var width = svgWidth - margin.left - margin.right;
                var height = svgHeight - margin.top - margin.bottom;

                var svg = d3.select("#chart-container")
                    .append("svg")
                    .attr("id", "line-chart")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight);

                var g = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                // Xử lý dữ liệu để chuyển nó thành mảng các đối tượng { month, accidents }
                var data = Object.keys(yearData).map(function(month) {
                    return { month: parseInt(month), accidents: yearData[month] };
                });

                // Xác định phạm vi của trục x và trục y
                var x = d3.scaleLinear().range([0, width]);
                var y = d3.scaleLinear().range([height, 0]);

                x.domain(d3.extent(data, function(d) { return d.month; }));
                y.domain([0, d3.max(data, function(d) { return d.accidents; })]);

                // Tạo đường biểu đồ
                var line = d3.line()
                    .x(function(d) { return x(d.month); })
                    .y(function(d) { return y(d.accidents); });

                // Vẽ đường biểu đồ
                g.append("path")
                    .datum(data)
                    .attr("class", "line")
                    .attr("d", line);

                // Thêm chấm tròn tại mỗi điểm dữ liệu
                g.selectAll(".dot")
                    .data(data)
                    .enter().append("circle")
                    .attr("class", "dot")
                    .attr("cx", function(d) { return x(d.month); })
                    .attr("cy", function(d) { return y(d.accidents); })
                    .attr("r", 5) // Đường kính của chấm tròn
                    .on("mouseover", function(d) {
                        var coordinates = d3.mouse(this);
                        var xPosition = coordinates[0];
                        var yPosition = coordinates[1];
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html("Số vụ tai nạn: " + d.accidents)
                            .style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });

                // Thêm nhãn cho mỗi điểm dữ liệu
                g.selectAll(".dot-label")
                    .data(data)
                    .enter().append("text")
                    .attr("class", "dot-label")
                    .attr("x", function(d) { return x(d.month); })
                    .attr("y", function(d) { return y(d.accidents) - 10; }) // Điều chỉnh vị trí nhãn
                    .text(function(d) { return d.accidents; });

                // Thêm trục x
                g.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).ticks(12).tickFormat(function(d) { return "Tháng " + d; }));

                // Thêm trục y
                g.append("g")
                    .call(d3.axisLeft(y));

                // Thêm tên cho trục x
                svg.append("text")
                    .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.top + 40) + ")")
                    .style("text-anchor", "middle")
                    .text("Tháng");

                // Thêm tên cho trục y
                svg.append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "3.8em")
                    .style("text-anchor", "middle")
                    .style("font-weight", "bold")
                    .text("Số lượng vụ tai nạn");

                // Tạo một tooltip
                var tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);
            }

            // Gọi hàm updateChart() để vẽ biểu đồ cho năm đầu tiên trong dữ liệu khi trang được tải
            updateChart(years[0]);

        }).catch(function(error) {
            console.error("Error loading the data: " + error);
        });
    </script>
</body>

</html>
